\begin{figure}[tp]
  \input{decl-types}
  \input{decl-dual}
  \declrel{Type equivalence}[$\convexpr{f} : T \eqt U$]
  \begin{mathpar}
    \inferrule[\EqUnit]{
    }{
      \convexpr{\ELam x x} :
      \TUnit \eqt \TUnit
      % : \ELam x x
    }

    \inferrule[\EqPair]{
      \convexpr{f_T} : T \eqt T' \\ %: f'_T \\
      \convexpr{f_U} : U \eqt U' %: f'_U
    }{
      \convexpr{\ELam {(x_1,x_2)} (f_T \; x_1, f_U \; x_2)} :
      \TPair T U \eqt \TPair {T'} {U'}
      % : \ELam {(x_1,x_2)} (f'_T \; x_1, f'_U \; x_2)
    }

    \inferrule[\EqFun]{
      \convexpr{f_{T'}} : T' \eqt T \\ %: f'_T \\
      \convexpr {f_U} : U \eqt U' %: f'_U
    }{
      \convexpr{\ELam x f_U \circ x \circ f_{T'}} :
      \TFun {T} {U} \eqt \TFun {T'} {U'}
      % : \ELam x f'_U \circ x \circ f_T
    }

    \inferrule[\EqS]{
      \convexpr{g} : R \eqs S
    }{
      \convexpr{\ELam {c_1} \EFork{ \ELam {c_2} g \; (c_1, c_2) }} :
      R \eqt S
      %: \ELam {c_1} \EFork{ \ELam {c_2} g' \; (c_1, c_2) }
    }
  \end{mathpar}
  \declrel{Session type equivalence}[$\eqsrel{g}{R}{S}$]
  \begin{mathpar}
    \inferrule[\EqAssump]{
      \convexpr{x} : \TRec R \eqs S \in \eqsctxt
    }{
      \eqsrel{x}{\TRec R}{S}
    }

    \inferrule[\EqUnrollL]{
      \eqsrel[\eqsctxt , \convexpr{x} : \TRec R \eqs S]
        {g}{R[\TRec R / X]}{S} \\
      \convexpr{x'} : \TRec R \eqs S \notin \eqsctxt
    }{
      \eqsrel{
        \ERec x
        \ELam{(c_1, c_2)}
        g \; (\EUnroll c_1, c_2)
      }{\TRec R}{S}
    }

    \inferrule[\EqUnrollR]{
      \eqsrel
      {g}{R}{S[\TRec S / X]}
      \\
      R \ne \TRec R'
    }{
      \eqsrel{
        \ELam{(c_1, c_2)}
        g \; (c_1, \EUnroll c_2)
      }{R}{\TRec S}
    }

    % \inferrule[\EqUnrollL]{
    %   \eqsrel[\eqsctxt , \convexpr{x} : \TRec S \eqs S']
    %     {g}{S[\TRec S / X]}{S'}
    % }{
    %   \eqsrel{
    %     \ERec x
    %     \ELam{(c_1, c_2)}
    %     g \; (\EUnroll c_1, c_2)
    %   }{\TRec S}{S'}
    % }
    %   
    % \inferrule[\EqUnrollR]{
    %   \eqsrel[\eqsctxt , \convexpr{x} : S \eqs \TRec S']
    %     {g}{S}{S'[\TRec S' / X]}
    % }{
    %   \eqsrel{
    %     \ERec x
    %     \ELam{(c_1, c_2)}
    %     g \; (c_1, \EUnroll c_2)
    %   }{S}{\TRec S'}
    % }
    %   
    \inferrule[\EqEnd !]{
    }{
      \eqsrel{
        \ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}
      }{\TEnd !}{\TEnd !}
    }

    \inferrule[\EqEnd ?]{
    }{
      \eqsrel{
        \ELam {(c_1, c_2)} \ELetU {\EWait {c_1}} {\ETerm {c_2}}
      }{\TEnd ?}{\TEnd ?}
    }

    \inferrule[\EqOut]{
      \convexpr{f} : U \eqt T \\
      \eqsrel{g}{R}{S}
    }{
      \colorlet{outer}{.}
      {\begin{array}{r@{}l}
        \eqsctxt \vdash
            \convcolor \ELam {(c_1, c_2)}
          & \convcolor \ELetP {u} {c_2} {\ERecv{c_2}} \\
          & \convcolor \hspace{-2em} \ELet {c_1} {\ESend {f \; u} {c_1}} \\
          & \convcolor \hspace{-2em} g \; (c_1, c_2)
            \color{outer} \hspace{4em}
              : \TOut {T} {R} \eqs \TOut {U} {S}
      \end{array}}
    }

    \inferrule[\EqSelect]{
      \eqsrel{g_i}{R_i}{S_i}
    }{
      \eqsctxt \vdash \convexpr{
        \ELam {(c_1, c_2)}
        \ECase {c_2} { l_i \rightarrow \ELam {c_2} g_i \; (\ESelect {l_i} c_1, c_2) } \\ {}
      } \\\\
      : \TSelect { l_i : R_i } \eqs \TSelect { l_i : S_i }
    }


    \inferrule[\EqIn]{
      \convexpr{f} : T \eqt U \\
      \eqsrel{g}{R}{S}
    }{
      \colorlet{outer}{.}
      {\begin{array}{r@{}l}
        \eqsctxt \vdash
            \convcolor \ELam {(c_1, c_2)}
          & \convcolor \ELetP {t} {c_1} {\ERecv{c_1}} \\
          & \convcolor \hspace{-2em} \ELet {c_2} {\ESend {f \; t} {c_2}} \\
          & \convcolor \hspace{-2em} g \; (c_1, c_2)
            \color{outer} \hspace{4em}
              : \TIn {T} {R} \eqs \TIn {U} {S}
      \end{array}}
    }

    \inferrule[\EqCase]{
      \eqsrel{g_i}{R_i}{S_i}
    }{
      \eqsctxt \vdash \convexpr{
        \ELam {(c_1, c_2)}
        \ECase {c_1} { l_i \rightarrow \ELam {c_1} g_i \; (c_1, \ESelect {l_i} c_2) }
      } \\\\
      : \TCase { l_i : R_i } \eqs \TCase { l_i : S_i }
    }
  \end{mathpar}
  \caption{Equi-recursive system: types, duality, inductive type and session type equivalence}
  \label{fig:equi-equivalence}
\end{figure}

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
