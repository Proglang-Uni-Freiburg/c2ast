
\section{Proofs}
\label{sec:properties}


\begin{proof}[Proof of Lemma~\ref{lemma:conversion}]
  \begin{enumerate}
  \item Induction on $T$ (beta equality is not sufficient; need
    reductions from computational lambda calculus, which are sound for
    call-by-value with effects)
    \begin{itemize}
    \item Case $\TUnit$: $f = \ELam x x$, $f' = \ELam x x$, clearly
      \begin{align*}
        (\ELam x (\ELam x x) ((\ELam x x) x)) &= \ELam x x
      \end{align*}
    \item Case $\TPair TU$: $f = \ELam {(x_1,x_2)} (f_T \; x_1, f_U \;
      x_2)$, $f' = \ELam {(x_1,x_2)} (f'_T \; x_1, f'_U \; x_2)$
      \begin{align*}
        \ELam x f' (f\; x)
        &= \ELam x f' (\ELetP{x_1}{x_2} x (f_T \; x_1, f_U \; x_2)) \\
        &= \ELam x \ELetP{x_1}{x_2}{ (\ELetP{x_1}{x_2} x (f_T \; x_1,
          f_U \; x_2))}  (f'_T \; x_1, f'_U \; x_2)\\
        &= \ELam x
          \ELetP{x_1}{x_2} x \ELetP{x_1}{x_2}{ (f_T \; x_1,
          f_U \; x_2)}  (f'_T \; x_1, f'_U \; x_2)\\
        &= \ELam x
          \ELetP{x_1}{x_2} x  (f'_T \; (f_T\; x_1), f'_U \; (f_U\;
          x_2))\\
        & \text{IH for }f_T, f_T', f_U, f_U' \\
        &= \ELam x
          \ELetP{x_1}{x_2} x  (x_1,x_2)\\
        &= \ELam x x
      \end{align*}
    \item Case $\TFun TU$: $f = \ELam x f_U \circ x \circ f_{T'}$, $f'
      = \ELam x f'_U \circ x \circ f_T$
      \begin{align*}
        \ELam x f' (f\; x)
        &= \ELam x f' ((\ELam x f_U \circ x \circ f_{T'})\; x) \\
        &= \ELam x (\ELam x f'_U \circ x \circ f_T)\; ((\ELam x f_U \circ x \circ f_{T'})\; x) \\
        &= \ELam x (\ELam x f'_U \circ x \circ f_T)\; (f_U \circ x \circ f_{T'}) \\
        &= \ELam x (f'_U \circ (f_U \circ x \circ f_{T'})
          \circ f_T) \\
        & \text{need to invoke extensionality to apply the IH in the
          form } f'_U \circ f_U = \ELam z z  \\
        &= \ELam x x
      \end{align*}
    \item Case $S$: $f = \ELam {c_1} \EFork{ \ELam {c_2} g \; (c_1,
        c_2) }$, 
      $f' = \ELam {c_1} \EFork{ \ELam {c_2} g' \; (c_1, c_2) }$
      \begin{align*}
        \ELam x f' (f\; x)
        &= \ELam x f' ((\ELam {c_1} \EFork{ \ELam {c_2} g \; (c_1,
          c_2) })\; x) \\
        &= \ELam x
          (\ELam {c_1} \EFork{ \ELam {c_2} g' \; (c_1, c_2)})
          ((\ELam {c_1} \EFork{ \ELam {c_2} g \; (c_1, c_2) })\; x) \\
        &= \ELam x
          (\ELam {c_1} \EFork{ \ELam {c_2} g' \; (c_1, c_2)})
          (\EFork{ \ELam {c_2} g \; (x, c_2) }) \\
        &= \ELam x
          \EFork{ \ELam {c_2} g' \; ((\EFork{ \ELam {c_2} g \; (x,
          c_2) }), c_2)} \\
        & \text{by part~2} \\
        & = \ELam x x
      \end{align*}
    \end{itemize}
  \item Just considering cases on $S$ is technically fishy. A proper
    proof would proceed by coinduction.
    \begin{itemize}
    \item Case $x : \TEnd!$:
      $g = \ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}$,
      $g' = \ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}$
      \begin{align*}
        & 
        \EFork{ \ELam {c_2} g' \; ((\EFork{ \ELam {c_2} g \; (x,
        c_2) }), c_2)} \\
        &=
        \EFork{ \ELam {c_2} g' \; ((\EFork{ \ELam {c_2} (\ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}) \; (x,
        c_2) }), c_2)} \\
        &=
        \EFork{ \ELam {c_2} (\ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}) \; ((\EFork{ \ELam {c_2} (\ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}) \; (x,
        c_2) }), c_2)} \\
        &=
          \PScope
          (\PPar a {(\ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}) \; ((\EFork{ \ELam {c_2} (\ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}) \; (x,
        c_2) }), b)}) \\
        &=
          \PScope
          (\PPar a {(\ELetU {\EWait {b}} {\ETerm {(\EFork{ \ELam {c_2} (\ELam {(c_1, c_2)} \ELetU {\EWait {c_2}} {\ETerm {c_1}}) \; (x,
        c_2) })}})}) \\
        &=
          \PScope
          (\PPar a {(\ELetU {\EWait {b}} {\ETerm {(\EFork{ \ELam {c_2} (\ELetU {\EWait {c_2}} {\ETerm {x}}) })}})}) \\
        &=
          \PScope
          (\PPar a {(\PScope[a',b'] \PPar {(\ELetU {\EWait {b}} {\ETerm
          {a'}}} {{ \ELetU {\EWait {b'}} {\ETerm {x}}) }})}) \\
        & \text{the typing dictates to consider }\ETerm a = \ETerm x \\
        & \PScope (\PPar {\ETerm a} {(\PScope[a',b'] \PPar {(\ELetU {\EWait {b}} {\ETerm
          {a'}}} {{ \ELetU {\EWait {b'}} {\ETerm {x}}) }})}) \\
        &=\PScope[a',b'] \PPar {({\ETerm
          {a'}}} {{ \ELetU {\EWait {b'}} {\ETerm {x}}) }} \\
        &=  \ETerm {x}
      \end{align*}
    \item the remaining cases are similar.
    \end{itemize}
  \end{enumerate}
\end{proof}




%%% Local Variables:
%%% mode: latex
%%% TeX-master: "main"
%%% End:
